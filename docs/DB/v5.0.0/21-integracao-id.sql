INSERT INTO VERSAO (DTH, NUMERO_VERSAO, SCRIPT) VALUES (SYSDATE, '5.0.0','21-integracao-id.sql');

CREATE TABLE ACAO_INTEGRACAO_FILTRO (
  COD_ACAO_INTEGRACAO_FILTRO NUMBER(8) NOT NULL,
  COD_ACAO_INTEGRACAO NUMBER(8) NOT NULL,
  COD_TIPO_REGISTRO NUMBER(8) NOT NULL,
  DSC_FILTRO VARCHAR2(500 BYTE),
  CONSTRAINT COD_ACAO_INTEGRACAO_FILTRO_PK PRIMARY KEY (COD_ACAO_INTEGRACAO_FILTRO),
  CONSTRAINT COD_SIGLA_FK FOREIGN KEY (COD_TIPO_REGISTRO) REFERENCES SIGLA (COD_SIGLA),
  CONSTRAINT COD_ACAO_INTEGRACAO_FK FOREIGN KEY (COD_ACAO_INTEGRACAO) REFERENCES ACAO_INTEGRACAO (COD_ACAO_INTEGRACAO)
);

CREATE SEQUENCE SQ_ACAO_INTEGRACAO_FILTRO_01 MINVALUE 0 MAXVALUE 999999999999999999999999999 INCREMENT BY 1 START WITH 1 NOCACHE NOORDER NOCYCLE;


INSERT INTO SIGLA (COD_SIGLA,COD_TIPO_SIGLA,DSC_SIGLA,COD_REFERENCIA_SIGLA)
  VALUES (610,79,'DATA ESPECIFICA','INTEGRACAO');

INSERT INTO SIGLA (COD_SIGLA,COD_TIPO_SIGLA,DSC_SIGLA,COD_REFERENCIA_SIGLA)
  VALUES (611,79,'CODIGO ESPECIFICO','INTEGRACAO');

INSERT INTO SIGLA (COD_SIGLA,COD_TIPO_SIGLA,DSC_SIGLA,COD_REFERENCIA_SIGLA)
  VALUES (612,79,'CONJUNTO CODIGOS','INTEGRACAO');

INSERT INTO SIGLA (COD_SIGLA,COD_TIPO_SIGLA,DSC_SIGLA,COD_REFERENCIA_SIGLA)
  VALUES (613,79,'INTERVALO CODIGO','INTEGRACAO');



--NOVAS QUERYS PARA INTEGRAÇÃO DE PEDIDOS
DELETE FROM ACAO_INTEGRACAO_ANDAMENTO WHERE COD_ACAO_INTEGRACAO = 3;
DELETE FROM ACAO_INTEGRACAO_FILTRO WHERE COD_ACAO_INTEGRACAO = 3;
DELETE FROM ACAO_INTEGRACAO WHERE COD_ACAO_INTEGRACAO = 3;

INSERT INTO ACAO_INTEGRACAO (COD_ACAO_INTEGRACAO,COD_CONEXAO_INTEGRACAO,DSC_QUERY,COD_TIPO_ACAO_INTEGRACAO,IND_UTILIZA_LOG,DTH_ULTIMA_EXECUCAO)
  VALUES (3,1,
  'SELECT c.numcar CARGA, v.placa PLACA, c.numped PEDIDO, c.codpraca COD_PRACA, pr.praca DSC_PRACA, pr.rota COD_ROTA, rota.descricao DSC_ROTA, c.codcli COD_CLIENTE, cli.cliente NOME, cli.cgcent CPF_CNPJ, cli.tipofj TIPO_PESSOA, cli.enderent LOGRADOURO, cli.numeroent NUMERO, cli.bairroent BAIRRO, cli.municent CIDADE, cli.estent UF, cli.complementoent COMPLEMENTO, cli.pontorefer REFERENCIA, cli.cepent CEP, i.codprod PRODUTO, '||'''UNICA'''||' GRADE, i.qt QTD, SUM(i.qt*i.pvenda) VLR_VENDA, TO_CHAR(TO_DATE(g.datamon || '||''' '''||'||g.horamon||'||''':'''||'||g.minutomon,'||'''DD/MM/YY HH24:MI:SS'''||'),'||'''DD/MM/YYYY HH24:MI:SS'''||') AS DTH FROM pcpedc c, pcpedi i, pcpraca pr, pcrotaexp rota, pcclient cli, pccarreg g, pcveicul v WHERE c.numped=i.numped AND c.codcli=cli.codcli AND pr.codpraca=c.codpraca AND pr.rota=rota.codrota AND c.numcar=g.numcar AND g.codveiculo=v.codveiculo AND c.posicao NOT IN ('||'''C'''||') AND g.datamon IS NOT NULL AND g.horamon IS NOT NULL AND g.minutomon IS NOT NULL :where GROUP BY c.numcar, v.placa, c.numped, c.codpraca, pr.praca, pr.rota, rota.descricao, c.codcli, cli.cliente, cli.cgcent, cli.tipofj, cli.enderent, cli.numeroent, cli.bairroent, cli.municent, cli.estent, cli.complementoent, cli.pontorefer, cli.cepent, i.codprod, i.qt, i.numseq, g.datamon, g.horamon, g.minutomon ORDER BY c.numped',
  602,'S',SYSDATE);

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 3, 610, ' AND TO_DATE(g.datamon || ' || ''' ''' || '||g.horamon||' || ''':''' || '||g.minutomon,' || '''DD/MM/YY HH24:MI:SS''' || ') > TO_DATE('||''':?1'''||','||'''DD/MM/YYYY HH24:MI:SS'''||') AND c.codfilial in ( :codFilial )');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 3, 611, ' AND c.numcar = :?1 ');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 3, 612, ' AND c.numcar IN (:?1) ');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 3, 613, ' AND c.numcar BETWEEN :?1 AND :?2 ');


--NOVAS QUERYS PARA INTEGRAÇÃO DE NOTAS FISCAIS DE ENTRADA
DELETE FROM ACAO_INTEGRACAO_ANDAMENTO WHERE COD_ACAO_INTEGRACAO = 7;
DELETE FROM ACAO_INTEGRACAO_FILTRO WHERE COD_ACAO_INTEGRACAO = 7;
DELETE FROM ACAO_INTEGRACAO WHERE COD_ACAO_INTEGRACAO = 7;

INSERT INTO ACAO_INTEGRACAO (COD_ACAO_INTEGRACAO,COD_CONEXAO_INTEGRACAO,DSC_QUERY,COD_TIPO_ACAO_INTEGRACAO,IND_UTILIZA_LOG,DTH_ULTIMA_EXECUCAO)
  VALUES (7,1,'select n.codfornec COD_FORNECEDOR, f.fornecedor NOM_FORNECEDOR, f.cgc CPF_CNPJ, '||'''UNICA'''||' DSC_GRADE, f.ie INSCRICAO_ESTADUAL, n.numnota NUM_NOTA_FISCAL, m.codprod COD_PRODUTO, n.serie COD_SERIE_NOTA_FISCAL, n.dtemissao DAT_EMISSAO, n.placaveiculo DSC_PLACA_VEICULO, sum(m.qt) QTD_ITEM, cast(sum(m.punit*m.qt) as numeric(15,2)) VALOR_TOTAL, TO_CHAR(m.dtmovlog, '||'''DD/MM/YYYY HH24:MI:SS'''||') as DTH from pcnfent n inner join pcfornec f on f.codfornec = n.codfornec inner join pcmov m on m.numtransent = n.numtransent where m.codoper in ('||'''E'''||','||'''EB'''||','||'''ET'''||') and f.revenda = '||'''S'''||' and codcont = '||'''100001'''||' :where group by n.codfornec, f.fornecedor, f.cgc, f.ie, n.numnota, n.serie, n.dtemissao, n.placaveiculo, m.codprod, '||'''UNICA'''||', m.dtmovlog order by n.codfornec',
  605,'S',SYSDATE);

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 7, 610, ' AND m.dtmovlog > TO_DATE('||''':?1'''||','||'''DD/MM/YYYY HH24:MI:SS'''||') AND m.codfilial IN (:codFilial) ');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 7, 611, ' AND n.numnota = :?1 AND n.serie = :?2 AND f.fornecedor = :?3 AND m.codfilial IN (:codFilial) ');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 7, 612, ' AND n.numnota IN (:?1) AND n.serie IN (:?2) AND f.fornecedor IN (:?3) AND m.codfilial IN (:codFilial) ');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 7, 613, ' AND n.numnota BETWEEN :?1 AND :?2 AND n.serie BETWEEN :?3 AND :?4 AND f.fornecedor BETWEEN :?5 AND :? 6 AND m.codfilial IN (:codFilial) ');


DELETE FROM ACAO_INTEGRACAO_ANDAMENTO WHERE COD_ACAO_INTEGRACAO = 8;
DELETE FROM ACAO_INTEGRACAO_FILTRO WHERE COD_ACAO_INTEGRACAO = 8;
DELETE FROM ACAO_INTEGRACAO WHERE COD_ACAO_INTEGRACAO = 8;

INSERT INTO ACAO_INTEGRACAO (COD_ACAO_INTEGRACAO,COD_CONEXAO_INTEGRACAO,DSC_QUERY,COD_TIPO_ACAO_INTEGRACAO,IND_UTILIZA_LOG,DTH_ULTIMA_EXECUCAO)
  VALUES (8,1,'select n.codfornec COD_FORNECEDOR, C.CLIENTE NOM_FORNECEDOR, c.cgcent CPF_CNPJ, '||'''UNICA'''||' DSC_GRADE, c.ieent INSCRICAO_ESTADUAL, n.numnota NUM_NOTA_FISCAL, m.codprod COD_PRODUTO, n.serie COD_SERIE_NOTA_FISCAL, n.dtemissao DAT_EMISSAO, n.placaveiculo DSC_PLACA_VEICULO, sum(m.qt) QTD_ITEM, cast(sum(m.punit*m.qt) as numeric(15,2)) VALOR_TOTAL, TO_CHAR(m.dtmovlog, '||'''DD/MM/YYYY HH24:MI:SS'''||') as DTH from pcnfent n, pcclient c, pcmov m where n.numtransent=m.numtransent and n.codfornec=c.codcli and m.codoper in ('||'''ED'''||') :where group by n.codfornec, c.cliente, c.cgcent, c.ieent, n.numnota, n.serie, n.dtemissao, n.placaveiculo, m.codprod, '||'''UNICA'''||', m.dtmovlog order by n.codfornec',
  605,'S',SYSDATE);

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 8, 610, ' AND m.dtmovlog > TO_DATE('||''':?1'''||','||'''DD/MM/YYYY HH24:MI:SS'''||') and m.codfilial IN (:codFilial) ');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 8, 611, ' AND n.numnota = :?1 AND n.serie = :?2 AND n.codfornec = :?3 AND m.codfilial IN (:codFilial) ');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 8, 612, ' AND n.numnota IN (:?1) AND n.serie IN (:?2) AND n.codfornec IN (:?3) AND m.codfilial IN (:codFilial) ');

INSERT INTO ACAO_INTEGRACAO_FILTRO (COD_ACAO_INTEGRACAO_FILTRO, COD_ACAO_INTEGRACAO, COD_TIPO_REGISTRO, DSC_FILTRO)
  VALUES (SQ_ACAO_INTEGRACAO_FILTRO_01.NEXTVAL, 8, 613, ' AND n.numnota BETWEEN :?1 AND :?2 AND n.serie BETWEEN :?3 AND :?4 AND n.codfornec BETWEEN :?5 AND :? 6 AND m.codfilial IN (:codFilial) ');