<style>

    label[for='etiquetas-pessoa'],
    label[for='etiquetas-etiquetaFinal'],
    label[for='mapas-codMapaSeparacao'],
    label[for='mapas-pessoa'],
    label[for='etiquetas-etiquetaInicial']{
        font-size: 16px;
        font-weight: bold;
        text-align: center;
    }

    .alterRow{
        background: #eaeaea;
    }

    .inptText{
        display: block;
        padding: 10px;
        border-radius: 10px;
        font-size: 25px !important;
        font-weight: bold;
        text-align: center;
        text-shadow: #9d9d9d;
    }
    
    .btnSearch{
        height: 40px;
        width: 150px;
        font-size: 20px !important;
        margin-top: 19px;
        margin-right: 10px;
    }

</style>
<script>
    function gotoFinal(event) {
        if (event.which == 13 || event.keyCode == 13) {
            if (document.getElementById('etiquetas-etiquetaInicial').value != "") {
                codBarrasFinal   = document.getElementById('etiquetas-etiquetaFinal');
                if (codBarrasFinal) {
                    codBarrasFinal.focus();
                    if(event.preventDefault) {
                        event.preventDefault();
                    } else {
                        event.returnValue = false;
                    }
                }
            }
        }
        return true;
    }

    function gotoPessoa(event) {
        if (event.which == 13 || event.keyCode == 13) {
            if (document.getElementById('etiquetas-etiquetaFinal').value != "") {
                pessoa   = document.getElementById('etiquetas-pessoa');
                if (pessoa) {
                    pessoa.focus();

                    if(event.preventDefault) {
                        event.preventDefault();
                    } else {
                        event.returnValue = false;
                    }
                }
            }
        }
        return true;
    }

    function gotoBuscar(event) {
        if (event.which == 13 || event.keyCode == 13) {
            if (document.getElementById('etiquetas-pessoa').value != "") {
                buscar   = document.getElementById('etiquetas-buscar');
                if (buscar) {
                    buscar.focus();

                    if(event.preventDefault) {
                        event.preventDefault();
                    } else {
                        event.returnValue = false;
                    }
                }
            }
        }
        return true;
    }

    function gotoPessoaMapa(event) {
        if (event.which == 13 || event.keyCode == 13) {
            if (document.getElementById('mapas-codMapaSeparacao').value != "") {
                pessoa   = document.getElementById('mapas-pessoa');
                if (pessoa) {
                    pessoa.focus();

                    if(event.preventDefault) {
                        event.preventDefault();
                    } else {
                        event.returnValue = false;
                    }
                }
            }
        }
        return true;
    }

    function gotoSalvarMapa(event) {
        if (event.which == 13 || event.keyCode == 13) {
            if (document.getElementById('mapas-pessoa').value != "") {
                buscar   = document.getElementById('mapas-salvarMapa');
                if (buscar) {
                    buscar.focus();

                    if(event.preventDefault) {
                        event.preventDefault();
                    } else {
                        event.returnValue = false;
                    }
                }
            }
        }
        return true;
    }

    $(function () {
        $('.btnSearch').prepend($('<img>').prop('src',basePath + "/img/icons/magnifier.png"));
        $('#mapas-salvarMapa').click(function () {
            var mapa = $('#mapas-codMapaSeparacao').val();
            var cpf = $('#mapas-pessoa').val();

            if (cpf == null || cpf == ""){
                alert("Informe um CPF");
                return false;
            } else if (cpf.length != 14) {
                alert("CPF incompleto ou inválido");
                return false;
            }

            $.ajax({
                url: 'conferente-apontamento-separacao/cpf/'+cpf,
                success: function (data) {
                    var tr = $('<tr>').addClass('gTResultSet');
                    tr.append($('<td>').css('text-align','left'));
                    tr.append($('<td>').css('text-align','left').text(data[0]['NOM_PESSOA']));
                    tr.append($('<td class="identifica">').css('text-align','left').text(cpf));
                    tr.append($('<td class="intervalo">').css('text-align','left').text(mapa));
                    tr.append($('<td>').css('text-align','left').text(1));
                    tr.append($('<td class="tipo">').css('text-align','left').text('Mapas'));
                    $('#tbResult').append(tr);
                }
            });
        });

        $("#etiquetas-buscar").click(function () {

            var eI = $('#etiquetas-etiquetaInicial').val();
            var eF = $('#etiquetas-etiquetaFinal').val();

            var qtdEtiquetas = 0;
            var intervalo = "N/D";

            if (eI != '' && eF != '') {

                if (eI.length < 2 || eF.length < 2) {
                    alert("Etiqueta fora do padrão");
                    return false;
                }

                eI = parseInt(eI.substring(0, eI.length - 1));
                eF = parseInt(eF.substring(0, eF.length - 1));

                if (eI > eF) {
                    alert("A etiqueta inicial não pode ser maior que a final.");
                    return false;
                } else if (eI == eF){
                    qtdEtiquetas = 1;
                    intervalo = eI + " - " + eF;
                } else {
                    qtdEtiquetas = eF - eI;
                    intervalo = eI + " - " + eF;
                }

            } else if (eI != "" && eF == "") {
                alert("Não é possível definir o intervalo sem a etiqueta final");
                return false;
            } else if (eI == "" && eF != "") {
                alert("Não é possível definir o intervalo sem a etiqueta inicial");
                return false;
            }

            var cpf = $('#etiquetas-pessoa').val();

            if (cpf == null || cpf == ""){
                alert("Informe um CPF");
                return false;
            } else if (cpf.length != 14) {
                alert("CPF incompleto ou inválido");
                return false;
            }

            $.ajax({
                url: 'conferente-apontamento-separacao/cpf/'+cpf,
                success: function (data) {

                    var tbody = $('#tbResult');
                    var tr = $('<tr>').addClass('gTResultSet');

                    tr.append($('<td>'));
                    tr.append($('<td>').text(data[0]['NOM_PESSOA']));
                    tr.append($('<td class="identifica">').text(cpf));
                    tr.append($('<td class="intervalo">').text(intervalo));
                    tr.append($('<td>').text(qtdEtiquetas));
                    tr.append($('<td class="tipo">').text('Etiquetas'));
                    tr.append(
                        $('<td>')
                            .css('text-align','center')
                            .append(
                            $('<a>')
                                .addClass('removeRow')
                                .prop('href', 'javascript://')
                                /*.attr('onclick','removeRow(this)')*/
                                .append(
                                    $('<img>').prop('src', basePath + "/img/icons/delete.png"))));
                    tbody.append(tr).trigger('tbChange');
                }
            });
        });

        $('#tbResult').bind('tbChange', function(){
            var anterior = null;
            $(this).children().each(function () {
                if (anterior !== null && !anterior.hasClass('alterRow')){
                    $(this).addClass('alterRow');
                } else if (anterior !== null && anterior.hasClass('alterRow')){
                    $(this).removeClass('alterRow');
                }
                anterior = $(this);
            })
        });

        $('.save').click(function () {
            var data = [];
            $.each($('#tbResult').children(), function () {
                var etiquetas = $(this).children(".intervalo").text();
                var cpf = $(this).children(".identifica").text();
                var tipo = $(this).children(".tipo").text();
                data.push({etiquetas:etiquetas, cpf:cpf, tipo:tipo});
            });
            $.post("apontamento-separacao", {data:data}).success(function (data) {
                if (data.result === 'Ok') {
                    alert('Todas as etiquetas foram salvas com sucesso!');
                    window.location.href = 'apontamento-separacao';
                }
            });
        });

        $(".removeRow").live('click', function () {
            if (confirm('Deseja realmente remover esse apontamento?')) {
                $(this).parent().parent().remove();
                $("#tbResult").trigger('tbChange');
            }
        });
    });
</script>

<?php
echo $this->form;
?>
<div id="exibe-pessoa-grid" class="grid">
    <table class="gTable ">
        <caption>Conferentes</caption>
        <tr class ="gTTitle">
            <td></td>
            <td width="32%">Nome</td>
            <td width="19%">CPF</td>
            <td width="14%">Inicial/Final</td>
            <td width="12%">Qtd. Etiquetas</td>
            <td width="12%">Tipo Conferência</td>
            <td width="7%" style="text-align: center">Remover</td>
        </tr>
        <tbody id="tbResult">
        </tbody>
    </table>
</div>


