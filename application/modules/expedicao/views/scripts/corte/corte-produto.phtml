<?php
    echo $this->form;
?>
<div id="gridCorte">
    <fieldset>
        <legend>Pedidos</legend>
        <form style="margin-bottom: -15px">
            <div align="right" class="gMassAction">
                <input style="margin: 5px 15px 5px 10px; width: 130px;" type="submit" name="total" id="corteTotal" value="Corte Total" class="btn">
            </div>
        </form>
        <form id="formGrid" action="?" method="post">
            <div id="expedicao-corte-produtos-grid" class="grid">
                <table class="gTable expedicao-corte-produtos-grid">
                    <tbody>
                        <tr class="gTTitle">
                            <td><span>Expedicao</span></td>
                            <td><span>Carga</span></td>
                            <td><span>Pedido</span></td>
                            <td><span>Mapa</span></td>
                            <td><span>Cod.Cliente</span></td>
                            <td><span>Cliente</span></td>
                            <td><span>Itinerario</span></td>
                            <td><span>Qtd.Pedido</span></td>
                            <td><span>Emb.Corte</span></td>
                            <td><span>Qtd.Cortar</span></td>
                            <td><span>Qtd.Conf</span></td>
                            <td><span>Qtd.Corte/Mapa</span></td>
                            <td><span>Qtd.Cortada Total</span></td>
                        </tr>
                    </tbody>
                    <tbody id="result-list">
                    </tbody>
                </table>
            </div>
        </form>
    </fieldset>
</div>

<div id="motivoCorte">
    <?php
        echo $this->formMotivo;
    ?>
</div>

<script>
    $(function () {

    let itens = [];
    let embs = [];
    let forcarEmbVenda = <?php echo ($this->forcaEmbVenda == "S") ? "true": "false" ?>;
    let idExpedicao = <?php echo $this->id ?>;
    let groups = {};

    function testShowGrid() {
        let grid = $("#gridCorte");
        if (!isEmpty(itens)) {
            grid.show();
        } else {
            grid.hide();
        }
    }

    function agroupItens() {
        groups = {maxByMap: [], maxByCli: []};
        $.each(itens, function (i, item) {
            if (isEmpty(item.consolidado)) {
                if (item.mapa in groups.maxByMap) {
                    groups.maxByMap[item.mapa].qtd += parseFloat(item.quantidadeUnitaria);
                    groups.maxByMap[item.mapa].corte += parseFloat(item.qtdCortadaUnitaria);
                } else {
                    groups.maxByMap[item.mapa] = {
                        qtd: parseFloat(item.quantidadeUnitaria),
                        corte: parseFloat(item.qtdCortadaUnitaria),
                        conf: parseFloat(item.qtdConf)
                    };
                }
            } else {
                let uniqIndex = item.codcli + "-*-" + item.mapa;
                if (uniqIndex in groups.maxByCli) {
                    groups.maxByCli[uniqIndex].qtd += parseFloat(item.quantidadeUnitaria);
                    groups.maxByCli[uniqIndex].corte += parseFloat(item.qtdCortadaUnitaria);
                } else {
                    groups.maxByCli[uniqIndex] = {
                        qtd: parseFloat(item.quantidadeUnitaria),
                        corte: parseFloat(item.qtdCortadaUnitaria),
                        conf: parseFloat(item.qtdConf)
                    };
                }
            }
        })
    }

    function updateList()
    {
        let newTd = function (content) {
            return $("<td style='text-align:left'></td>").append( content );
        };
        let tbody = $("#result-list");
        tbody.html("");

        agroupItens();

        $.each(itens, function (i, item) {
            let newRow = $("<tr class='gTResultSet' id='row-item-" + i + "' >");

            newRow.append( newTd( idExpedicao ) );
            newRow.append( newTd( item.carga ) );
            newRow.append( newTd( item.id ) );
            newRow.append( newTd( item.mapa ) );
            newRow.append( newTd( item.codcli ) );
            newRow.append( newTd( item.cliente ) );
            newRow.append( newTd( item.itinerario ) );
            newRow.append( newTd( item.quantidade ) );
            let newEmbSelector = "";
            if (!isEmpty(embs)) {
                newEmbSelector = $("<select id='emb-" + i + "' data-index='" + i + "' class='qtdCortar' ></select>");
                if (forcarEmbVenda) newEmbSelector.prop("disabled", true);
                $.each(embs, function (l, emb) {
                    let selecionado = (forcarEmbVenda && (emb.fator == item.fatorEmbalagemVenda)) ? "selected" : "";
                    newEmbSelector.append("<option " + selecionado + " value='" + emb.id + "' data-index='" + l + "'>" + emb.dscEmb + "</option>");
                });
            }
            newRow.append( newTd( newEmbSelector ) );
            newRow.append( newTd( $("<input style='width:40px;' type='text' class='qtdCortar' id='qtdCortar-" + i + "' data-index='" + i + "'>") ) );
            newRow.append( newTd( item.qtdConf ) );
            newRow.append( newTd( item.qtdCortada ) );
            newRow.append( newTd( item.qtdCorteTotal ) );

            tbody.append(newRow);
        })
    }

    function getSaldoCorte(index) {
        let item = itens[index];
        let obj = {};
        let totalCorte = getCorte(index);

        if (parseFloat(item.quantidadeUnitaria - item.qtdCorteTotalUnitaria) < totalCorte) {
            return false;
        }

        if (!isEmpty(item.consolidado)) {
            obj = groups.maxByCli[item.codcli + "-*-" + item.mapa];
        } else {
            $.each(itens, function (i, itemList) {
                if (item.mapa === itemList.mapa && item.id !== itemList.id) {
                    totalCorte += getCorte(i);
                }
            });
            obj = groups.maxByMap[item.mapa]
        }

        let fator = parseFloat(embs[0].fator);

        let saldo = parseFloat((obj.qtd - parseFloat(obj.corte + obj.conf)) / fator);
        return (saldo > 0 && totalCorte <= saldo);
    }

    function getCorte(i) {
        let indexEmb = $("#emb-"+i).find(":selected").data("index");
        let qtd = $("#qtdCortar-"+i).val();
        return (indexEmb !== undefined && qtd !== undefined) ? parseFloat(qtd * embs[indexEmb].fator) : 0;
    }

    function msg(input, inputQtd) {
        let funct = function (objInput) {
            objInput.inputQtd.val("");
            objInput.inputEven.focus();
        };
        let args = {inputQtd: inputQtd, inputEven: input};
        let text = "A quantidade excede o saldo do mapa ou do pedido disponível para corte!";

        $.wmsDialogAlert({msg: text + " <br><br> Para efetuar o corte: <br>Utilize uma embalagem menor, <br>Reduza a quantidade, <br> Ou reinicie a conferência do item!"},
            funct ,
            args
        );
    }

    $("select.qtdCortar, input.qtdCortar").live("change", function () {
        event.preventDefault();
        let input = $(this);
        let index = input.data("index");
        let inputQtd = $("#qtdCortar-"+index);
        console.log("exibe");
        if (!getSaldoCorte(index))
        {
            msg(input, inputQtd);
        }
    });

    function confirmaCorte()
    {
        event.preventDefault();

        let cortes = [];

        $.each(itens, function (i, item) {
            let qtdCortar = $("#qtdCortar-" + i).val();
            if (!isEmpty(qtdCortar)) {
                var corte = [];
                corte[0] = item.ID;
                corte[1] = $("#emb-" + i).val();
                corte[2] = qtdCortar;
                corte[3] = item.mapa;

                cortes[cortes.length] = corte;
            }
        });

        if (cortes.length <= 0) {
            $.wmsDialogAlert({msg:"Selecione ao menos um pedido para cortar"});
            return;
        }

        if ($('#motivo').val() == "") {
            $.wmsDialogAlert({msg:"Selecione um motivo de corte"});
            return;
        }

        $.ajax({
            url:  URL_MODULO + '/corte/confirma-corte-produto-ajax/',
            type: 'post',
            data: {
                codProduto: $('#codProduto').val(),
                grade: $('#grade').val(),
                motivo: $('#motivo').val(),
                cortes: cortes,
            },
            success: function (data) {
                if (data.error) {
                    $.wmsDialogAlert({msg:data.error});
                } else {
                    itens = [];
                    testShowGrid();
                    $("#result-list").html("");
                    $("#motivoCorte").html("");
                    $.wmsDialogAlert({msg:"Produto cortado com sucesso"}, function () {
                        $('#grade').val("UNICA");
                        $('#codProduto').val("").focus();
                    });
                }
            }
        });
    }

    $("#corteTotal").click( function(e) {
        e.preventDefault();
        let temConf = false;
        $.each(itens, function (i, item) {
            if (isEmpty(item.consolidado)) {
                if (!isEmpty(groups.maxByMap[item.mapa].conf) && groups.maxByMap[item.mapa].conf > 0) {
                    temConf = true;
                }
            } else {
                let uniqIndex = item.codcli + "-*-" + item.mapa;
                if (!isEmpty(groups.maxByCli[uniqIndex].conf) && groups.maxByCli[uniqIndex].conf > 0) {
                    temConf = true;
                }
            }
            if (temConf) return false;
            $("#emb-"+i).val($("emb-"+i+" option:first").val());
            $("#qtdCortar-"+i).val(getSaldoCorte(i));
        });

        if (temConf) {
            $.wmsDialogAlert({msg: "O produto já teve conferências, o corte total não pode ser aplicado! <br> Reinicie a(s) conferência(s) e tente novamente!"});
        }
    });

    function executeRequest() {
        $.ajax({
            url: URL_MODULO + '/corte/get-data-produto-corte-ajax/',
            type: 'post',
            data: {
                id: idExpedicao,
                codProduto: $('#codProduto').val(),
                grade: $('#grade').val()
            },
            success: function (data) {
                if (data.status === "error") {
                    $("#motivoCorte").html("");
                    $.wmsDialogAlert({msg: data.msg});
                } else {
                    itens = data.itens;
                    embs = data.embs;
                    updateList();
                    $("#motivoCorte").html(data.formMotivo);
                    testShowGrid();
                }
            }
        });
    }

    $('#btnSubmit').click(function () {
        validate();
    });

    $("input#codProduto, input#grade").keypress(function( event ) {
        if ((event.which === 13 || event.keyCode === 13)) {
            validate();
        }
    });

    function validate()
    {
        if (!isEmpty($("input#codProduto").val())){
            executeRequest();
        }
        else {
            $.wmsDialogAlert({msg: "Informe o código do produto!"});
        }
    }

    testShowGrid();
    })
</script>
