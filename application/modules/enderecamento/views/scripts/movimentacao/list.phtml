<table class="gTable ">

    <caption>Estoque do produto - Picking cadastrado: <?php echo $this->endPicking; ?></caption>
    <tbody>
    <?php
    $enderecoAnterior = null;
    $codProdutoAnterior = null;
    $gradeAnterior = null;
    $codVolumeAnterior = null;
    $qtdEstoque = 0;
    $qtdReservaEntrada = 0;
    $qtdReservaSaida = 0;
    $qtdEstoqueFinal = 0;
    $arrayEnderecos = array();

    foreach($this->enderecos as $endereco) {
        if (($codProdutoAnterior != $endereco['COD_PRODUTO']) || ($gradeAnterior != $endereco['DSC_GRADE'])) { ?>

            <tr class ="gTTitle">
                <td><b><?php echo "CÓDIGO: " . $endereco['COD_PRODUTO']?></b></td>
                <td><b><?php echo "GRADE: " . $endereco['DSC_GRADE']?></b></td>
                <td><b><?php echo "PRODUTO: " . $endereco['DSC_PRODUTO']?></b></td>
                <td colspan="3"></td>
            </tr>

            <tr>
                <td><b>Endereço</b></td>
                <td><b>Tipo</b></td>
                <td><b>Data de Entrada</b></td>
                <td><b>Reserva Entrada</b></td>
                <td><b>Reserva Saida</b></td>
                <td><b>Qtd.Estoque</b></td>
            </tr>

            <?php foreach ($arrayEnderecos as $key => $endereco) : ?>
                <tr>
                    <td><?php echo $key ?></td>
                    <td><?php echo $endereco['ENDERECO']['TIPO'] ?></td>
                    <td><?php echo $endereco['DTH_PRIMEIRA_MOVIMENTACAO'] ?></td>
                    <td><?php echo $endereco['ENDERECO']['RESERVA_ENTRADA'] ?></td>
                    <td><?php echo $endereco['ENDERECO']['RESERVA_ENTRADA'] ?></td>
                    <td><?php echo $endereco['ENDERECO']['QTD'] ?></td>
                </tr>
            <?php endforeach; ?>

            <?php if ($codProdutoAnterior != NULL) { ?>
                <tr >
                    <td colspan="3"><b>Total</b></td>
                    <td><b><?php echo $qtdReservaEntrada?></b></td>
                    <td><b><?php echo $qtdReservaSaida?></b></td>
                    <td><b><?php echo $qtdEstoqueFinal?></b></td>
                </tr>
            <?php
            }

            $arrayEnderecos = null;
            $qtdEstoqueFinal = 0;
            $qtdReservaEntrada = 0;
            $qtdReservaSaida = 0;
            ?>

        <?php } ?>

        <?php if (array_key_exists($endereco['ENDERECO'], $arrayEnderecos)) {
            $arrayEnderecos[$endereco['ENDERECO']]['QTD'] = $arrayEnderecos[$endereco['ENDERECO']]['QTD'] + $endereco['QTD'];
            $arrayEnderecos[$endereco['ENDERECO']]['RESERVA_ENTRADA'] = $arrayEnderecos[$endereco['ENDERECO']]['RESERVA_ENTRADA'] + $endereco['RESERVA_ENTRADA'];
            $arrayEnderecos[$endereco['ENDERECO']]['RESERVA_SAIDA'] = $arrayEnderecos[$endereco['ENDERECO']]['RESERVA_SAIDA'] + $endereco['RESERVA_SAIDA'];
        } else {
            $arrayEnderecos[$endereco['ENDERECO']]['COD_PRODUTO'] = $endereco['COD_PRODUTO'];
            $arrayEnderecos[$endereco['ENDERECO']]['DSC_GRADE'] = $endereco['DSC_GRADE'];
            $arrayEnderecos[$endereco['ENDERECO']]['DSC_PRODUTO'] =  $endereco['DSC_PRODUTO'];
            $arrayEnderecos[$endereco['ENDERECO']]['ENDERECO'] = $endereco['ENDERECO'];
            $arrayEnderecos[$endereco['ENDERECO']]['DTH_PRIMEIRA_MOVIMENTACAO'] = $endereco['DTH_PRIMEIRA_MOVIMENTACAO'];
            $arrayEnderecos[$endereco['ENDERECO']]['TIPO'] = $endereco['TIPO'];
            $arrayEnderecos[$endereco['ENDERECO']]['QTD']  = $arrayEnderecos[$endereco['ENDERECO']]['QTD'] + $endereco['QTD'];
            $arrayEnderecos[$endereco['ENDERECO']]['RESERVA_ENTRADA'] = $arrayEnderecos[$endereco['ENDERECO']]['RESERVA_ENTRADA'] + $endereco['RESERVA_ENTRADA'];
            $arrayEnderecos[$endereco['ENDERECO']]['RESERVA_SAIDA'] = $arrayEnderecos[$endereco['ENDERECO']]['RESERVA_SAIDA'] + $endereco['RESERVA_SAIDA'];
        } ?>


        <?php
        $codProdutoAnterior = $endereco['COD_PRODUTO'];
        $gradeAnterior = $endereco['DSC_GRADE'];
        $qtdEstoqueFinal = $qtdEstoqueFinal + $qtdEstoque;
        ?>
    <?php } ?>

</table>

