<?php echo $this->render('recebimento/produto-detalhes.phtml');

$cssQtd = 'col-xs-12';

if ($this->itemNF['validade'] == 'S') {
    $cssQtd = 'col-lg-3 col-md-4 col-xs-5';
}

?>
<div class="row" >
    <form method="post" id="recebimento-embalagem-quantidade-form" action="<?php echo $this->url(array('controller' => 'recebimento', 'action' => 'produto-conferencia')); ?>" accept-charset="UTF-8" enctype="application/x-www-form-urlencoded">

        <input type="hidden" id="idRecebimento" name="idRecebimento" value="<?php echo $this->recebimento->getId() ?>" />
        <input type="hidden" id="idItem" name="idItem" value="<?php echo $this->itemNF['idItem'] ?>" />
        <input type="hidden" id="idProdutoEmbalagem" name="idProdutoEmbalagem" value="<?php echo $this->itemNF['idEmbalagem'] ?>" />
        <input type="hidden" id="unidadePorEmbalagem" name="unidadePorEmbalagem" value="<?php echo ($this->indFracionavel != "S") ? $this->itemNF['quantidadeEmbalagem'] : 1 ?>" />
        <input type="hidden" id="isEmbFracDefault" name="isEmbFracDefault" value="<?php echo $this->embFracionavelDefault ?>" />

        <div class="row margin-row">
            <div class="col-md-4 col-xs-4 text-center">
                <div class="row"><b>Descrição Emb.</b></div>
                <div class="row">
                    <?php if ($this->embFracionavelDefault == 'S'){
                        $txtEmb = \Wms\Domain\Entity\Produto::$listaUnidadeMedida[$this->itemNF['unidFracao']];
                        $dscEmb = $this->itemNF['descricaoEmbalagem']." ($txtEmb)";
                        echo $dscEmb;
                    } else {
                        echo $this->itemNF['descricaoEmbalagem'];
                    }
                    ?>
                </div>
            </div>
            <div class="col-md-8 col-xs-5 text-center">
                <div class="row"><b>Código de Barras</b></div>
                <div class="row"><?php echo $this->itemNF['codigoBarras'] ?></div>
            </div>
        </div>
        <div class="row margin-row">
            <div class="col-md-4 col-xs-4 text-center">
                <div class="row"><b>Norma:</b></div>
                <div class="row"><?php echo $this->itemNF['numLastro'] . ' x ' . $this->itemNF['numCamadas'] . ' = ' . $this->itemNF['numNorma'] ?></div>
            </div>
            <div class="col-md-8 col-xs-5 text-center">
                <div class="row"><label class="field required" for="idNormaPaletizacao">Unitizador</label></div>
                <div class="row">
                    <select class="required" id="idNormaPaletizacao" name="idNormaPaletizacao">
                    <?php foreach ($this->normasPaletizacao as $id => $descricao): ?>
                        <option value="<?php echo $id; ?>" <?php echo $this->itemNF['idNorma'] == $id ? "selected" : ""; ?>><?php echo $descricao; ?></option>
                    <?php endforeach; ?>
                    </select>
                </div>
            </div>
        </div>
        <div class="row margin-row">
            <div class="col-xs-9 text-center">
            <?php if ($this->indFracionavel != 'S') : ?>
                <b>Unids. Por Emb. : <?php echo $this->itemNF['quantidadeEmbalagem'] ?></b>
            <?php elseif ($this->indFracionavel == 'S' && !empty($this->dscEmbFracDefault)) : ?>
                <b><label class="field required" for="qtdUnidFracionavel">Qtd de: <?php echo $this->dscEmbFracDefault ?>'s</label></b>
                <input type="text" value="1" size="6" name="qtdUnidFracionavel" id="qtdUnidFracionavel" class="required"/>
            <?php endif; ?>
            </div>
        </div>
        <?php if ($this->controlaLote == 'S') : ?>
            <div class="row margin-row">
                <div class="col-xs-10">
                    <label class="field required" for="lote">
                        <b>Lote: </b>
                        <input type="text" size="11" class="required" id="lote" name="lote"/>
                    </label>
                </div>
            </div>
        <?php endif; ?>
        <?php if ($this->itemNF['validade'] == 'S') : ?>
        <div class="row margin-row">
            <div class="col-xs-10">
                <label class="required" for="dataValidade">
                    <b>Data Validade: </b>
                    <input type="text" placeholder="dd/mm/yy" maxlength="8" size="6" class="required" id="dataValidade" name="dataValidade"/>
                </label>
            </div>
        </div>
        <?php endif; ?>
        <div class="row margin-row">
            <div class="col-md-4 col-xs-5 text-center">
            <?php if ($this->pesoVariavel != 'S') :
                if ($this->indFracionavel == "S") :?>
                <div class="row margin-row">
                    <b><label class="field required" for="qtdConferida"><?php echo \Wms\Domain\Entity\Produto::$listaUnidadeMedida[$this->itemNF['unidFracao']] . "S"?></label></b>
                </div>
                <div class="row">
                    <input type="text" maxlength="15" size="6" class="required" id="qtdConferida" name="qtdConferida" />
                </div>
                <?php else : ?>
                <div class="row">
                    <b><label class="field required" for="qtdConferida">Quantidade</label></b>
                </div>
                <div class="row">
                    <input type="text" maxlength="15" size="6" class="required" id="qtdConferida" name="qtdConferida" />
                </div>
                <?php endif;
            else : ?>
                <div class="row">
                    <b><label class="field required" for="numPeso">Peso (Kg)</label></b>
                </div>
                <div class="row">
                    <input type="text" maxlength="15" size="6" class="required" id="numPeso" name="numPeso"/>
                </div>
            <?php endif; ?>
            </div>
            <div class="col-ls-3 col-md-3 col-xs-4 margin-row text-center">
            <?php if ($this->indFracionavel != 'S') : ?>
                <div class="row"><b>Total Unidades</b></div>
            <?php else : ?>
                <div class="row"><b>Total Recebido</b></div>
            <?php endif; ?>
                <div class="row">
                    <span id="totalQuantidade">0</span>
                </div>
            </div>
        </div>

        <div class="row margin-row">
            <?php if ($this->indFracionavel == 'S') : ?>
                <p>Para a fração utilizar ponto "." ex.: 3.25</p>
            <?php endif; ?>
            <input type="submit" class="btn gradientBtn" value="Salvar" id="submit" name="submit">
        </div>
    </form>
</div>

<script>
    $(function () {
        var controlaLote     = <?php echo ($this->controlaLote == 'S') ? "true" : "false"?>;
        var controlaValidade = <?php echo ($this->itemNF['validade'] == 'S') ? "true" : "false"?>;
        var pesoVariavel     = <?php echo ($this->pesoVariavel == 'S') ? "true" : "false"?>;

        $(document).ready(function () {
            if (controlaLote) {
                $("#lote").focus()
            } else if (controlaValidade) {
                $("#dataValidade").focus()
            } else if (pesoVariavel) {
                $("#numPeso").focus()
            } else {
                $("#qtdConferida").focus()
            }

        });

        $("input:text").keyup(function (event) {
            if ( event.which === 13  || event.keyCode === 13 ) {
                console.log("entrou");
                if (! checkInputs() ) {
                    if (event.preventDefault) {
                        event.preventDefault();
                    } else {
                        event.returnValue = false;
                    }
                }
            }
        });

        var checkInputs = function () {

            var inputQtd = (!pesoVariavel) ? $("#qtdConferida") : $("#numPeso") ;
            var inputVal = $("#dataValidade");
            var inputLote = $("#lote");

            if ( controlaLote && isEmpty(inputLote.val())) {
                inputLote.focus();
                return false;
            }

            if ( controlaValidade && isEmpty(inputVal.val())) {
                inputVal.focus();
                return false;
            }
            if (isEmpty(inputQtd.val())) {
                inputQtd.focus();
                return false;
            }

            return true;
        };

        $("#dataValidade").keyup(function (event) {

            var v = $(this).val();

            v = v.replace(/\D/g, "");
            v = v.replace(/(\d{2})(\d)/, "$1/$2");
            v = v.replace(/(\d{2})(\d)/, "$1/$2");
            v = v.replace(/(\d{2})(\d{2})$/, "$1$2");

            $(this).val(v);

            if (v != '' && v.length == 8) {

                var strRegex = /^(((([0-2][0-8]|09|19)(-|\/)(0[1-9]|1[012]))|((29|30|31)(-|\/)(0[13578]|1[02]))|((29|30)(-|\/)(0[469]|11)))(-|\/)(\d{2}))|((29)(-|\/)(02)(-|\/)(([02468][048])|([13579][26])))$/;
                var regexp = new RegExp(strRegex);
                if (!regexp.test(v)) {
                    alert('A data ' + v + ' é inválida');
                    $(this).val('');
                    return false;
                } else {
                    if (checkValidade()) {
                        var quantidade = document.getElementById('qtdConferida');
                        if (quantidade) {
                            quantidade.focus();
                            if (event.preventDefault) {
                                event.preventDefault();
                            } else {
                                event.returnValue = false;
                            }
                        }
                    }
                }
            }

        });

        $("#recebimento-embalagem-quantidade-form").submit(function (event) {
            if (!checkInputs()) return false;
            return checkValidade();
        });

        function checkValidade() {
            var obj = $("#dataValidade");
            if (obj.length) {
                var data = obj.val();
                if (data.length < 8) {
                    alert("O campo 'Data de validade' não foi preenchido corretamente!");
                    return false;
                }
                var hj = new Date();
                var validade = gerarData(data);
                if (validade <= hj) {
                    alert("A data de validade não pode ser menor ou igual a data atual");
                    obj.val('');
                    return false;
                }
            }
            return true;
        }

        function gerarData(str) {
            var partes = str.split("/");
            return new Date("20" + partes[2], partes[1] - 1, partes[0]);
        }
    })
</script>