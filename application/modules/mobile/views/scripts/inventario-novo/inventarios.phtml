<?php
/**
 * Created by PhpStorm.
 * User: Tarcísio César
 * Date: 14/12/2018
 * Time: 10:51
 */
?>
<script src="<?php echo $this->baseUrl('angularJS/angular.js') ?>"></script>
<script src="<?php echo $this->baseUrl('angularJS/wmsAngular.js') ?>"></script>
<style>
    .btn {
        width: 95%;
    }

    .lbl-headers {
        font-size: 15px;
        font-weight: bold;
        padding: 0 6px;
    }

    div.input-area {
        padding: 10px;
        margin: 10px 15px;
        background-color: #f3f3f3;
        border-radius: 10px;
    }

    html, body {
        margin:0;
        height: 100%;
    }

    .btn-spacing {
        margin-top: 5px;
    }

    .list-area {
        overflow-y: auto;
        max-height: inherit
    }

    .list-item {
        width: 100%!important;
        margin: 3px 0px !important;
        padding: 0px !important;
        text-align: center!important;
        font-weight: bold;
    }

    .div-loader {
        float:left;
        z-index: 9000;
        padding-top: 30px;
        position: absolute;
        background: #FFFFFF;
        width: 100%;
        height: inherit;
    }
</style>

<span id="dummy"></span>
<bgsound id="bgSoundId" loop="0" volume="100" />

<div id="loader" class="div-loader">
    <span style="font-size: 18px">Carregando...</span>
    <img src="/img/ajax-bar-loader.gif" alt="loading">
</div>

<div id="messenger"></div>

<!--<div style="display: none" id="divBtnBack">-->
<!--    <button class="btn btnAlerta" id="btn-back-action">Voltar</button>-->
<!--</div>-->

<div id="headers" style="padding-top: 5px">
    <div class="lbl-headers" id="lbl-inventario"></div>
    <div class="lbl-headers" id="lbl-contagem"></div>
    <div class="lbl-headers" id="lbl-endereco"></div>
    <div class="lbl-headers" id="lbl-produto"></div>
    <div class="lbl-headers" id="lbl-embvol"></div>
</div>

<div id="list-inventarios" style="display: none;">
    <h3>Inventários disponíveis</h3>
    <p id="list-empty">Nenhum Inventário liberado para conferência.</p>
    <div id="list-inventarios"></div>
</div>

<div id="contagens-by-inventario" style="display: none">
    <h3>Contagens</h3>
    <div id="list-contagens"></div>
</div>

<div id="bipagem-endereco" style="display: none">
    <div class="input-area">
        <div class="field">
            <form>
                <label for="cod-barras-end" class="field required"><div class="lbl-headers">Buscar Endereço</div></label>
                <input type="text" name="cod-barras-end" id="cod-barras-end" value="" class=" required focus" size="40" maxlength="100" style="width: 99%" alt="numeric">
            </form>
        </div>
        <button id="btn-consultar-endereco" class="btn btn-spacing">Buscar</button>
    </div>
    <div class="list-area" id="list-enderecos"></div>
</div>

<div id="bipagem-produto" style="display: none">
    <div class="input-area">
        <div class="field">
            <form>
                <label for="cod-barras-prod" class="field required"><div class="lbl-headers">Buscar Produto</div></label>
                <input type="text" name="cod-barras-prod" id="cod-barras-prod" value="" class=" required focus" size="40" maxlength="100" style="width: 99%" alt="numeric">
            </form>
        </div>
        <button id="btn-consultar-produto" class="btn btn-spacing">Buscar</button>
        <button id="btn-finalizar" class="btn btn-spacing gradientBtnSuccess"></button>
    </div>
    <div class="list-area" id="list-produtos"></div>
</div>

<div id="conferencia" style="display: none">
    <div class="input-area">
        <form>
            <div class="field">
                <label for="qtd" class="field required"><div class="lbl-headers">Quantidade</div></label>
                <input type="text" name="qtd" id="qtd" value="" class="required focus" size="10" maxlength="15">
            </div>
            <div class="field" id="div-validade">
                <label for="validade" class="field optional"><div class="lbl-headers">Validade</div></label>
                <input type="text" name="validade" id="validade" value="" size="10" maxlength="8" placeholder="dd/mm/yy">
            </div>
            <div class="field" id="div-lote">
                <label for="lote" class="field optional"><div class="lbl-headers">Lote</div></label>
                <input type="text" name="lote" id="lote" value="" size="10" maxlength="8" placeholder="dd/mm/yy">
            </div>
        </form>
        <button id="btn-registrar" class="btn btn-spacing">Registrar</button>
    </div>
</div>

<script>
    $(function () {
        var inventarios = [];
        var invSelecioando = {};
        var contagens = [];
        var contSelecioando = {};
        var enderecos = [];
        var idEndSelecionado = null;
        var dscEndSelecionado = null;
        var produtos = [];
        var elemBipado = {};
        var usaGrade = true;
        var showing = 0;
        var views = ["loader","list-inventarios","contagens-by-inventario","bipagem-endereco","bipagem-produto","conferencia"];
        var headers = ["lbl-inventario", "lbl-contagem", "lbl-endereco", "lbl-produto"];
        var endConfig = {};
        var msgShowed = true;

        $(document).ready(function () {
            changeViewer("loader");
            getInventarios();
            $.ajax({ url: "/configuracao/get-mask-endereco-ajax",
                success: function (result) {
                    endConfig.rua = result.enderecoRua.replace(/[9]/g,"0");
                    endConfig.predio = result.enderecoPredio.replace(/[9]/g,"0");
                    endConfig.nivel = result.enderecoNivel.replace(/[9]/g,"0");
                    endConfig.apto = result.enderecoApartamento.replace(/[9]/g,"0");
                    endConfig.mask = result.mask.replace(/[9]/g,"0");
                }
            })
        });

        var disarmEvent = function (event) {
            if (event.preventDefault) {
                event.preventDefault();
            } else {
                event.returnValue = false;
            }
        };

        var notificar = function (type, msg, instantShowed) {
            if (type === undefined) type = "success";

            var songFile = "/alarme_curto.mp3";
            if (type === "success") {
                songFile = "/confirm2.mp3";
            }

            $("#dummy").html('<embed src="' + songFile + '" hidden="true" autostart="true" loop="false" />');
            var audio = new Audio(songFile);
            audio.play();

            $("#messenger").html(
                '<ul class="flashMessenger">' +
                '    <li class="' + type + '_message" id="">' +
                '        <div style="display:block; float:right;">' +
                '            <a href="#" class="fmBtnClose">X</a>' +
                '        </div>' +
                '        <div style="display: block;" id="msg-text">' + msg + '</div>' +
                '    </li>' +
                '</ul>');

            if (type === "error") alert(msg);
            msgShowed = instantShowed;
        };

        $(".fmBtnClose").live("click", function () {
            $("#messenger").empty();
        });

        var formatEndereco = function (endereco) {
            var cleared = endereco.slice(0, endereco.length - 1);
            var rua = endConfig.rua.toString();
            var predio = endConfig.predio.toString();
            var nivel = endConfig.nivel.toString();
            var apto = endConfig.apto.toString();
            if (cleared.indexOf(".") > 0) {
                var endArr = cleared.split(".");

                if (endArr.length < 4) return false;

                rua = (rua + endArr[0].toString()).slice(-endConfig.rua.length);
                predio = (predio + endArr[1].toString()).slice(-endConfig.predio.length);
                nivel = (nivel + endArr[2].toString()).slice(-endConfig.nivel.length);
                apto = (apto + endArr[3].toString()).slice(-endConfig.apto.length);
            } else {
                var maskLength = endConfig.mask.replace(/\D/g,'').length;

                if (cleared.length < maskLength) return false;

                var endTrimned = cleared.slice(cleared.length - maskLength , cleared.length);
                rua = endTrimned.slice(0 , rua.length);
                predio = endTrimned.slice(rua.length , rua.length + predio.length);
                nivel = endTrimned.slice(rua.length + predio.length , rua.length + predio.length + nivel.length);
                apto = endTrimned.slice(rua.length + predio.length + nivel.length , rua.length + predio.length + nivel.length + apto.length);
            }

            return [rua,predio,nivel,apto].join(".");
        };

        var changeViewer = function (showTo) {
            $.each(views, function (k,v) {
                $("#"+v).hide();
            });

            if (showTo === undefined || views.indexOf(showTo) < 0) {
                showTo = views[1];
            }

            showing = views.indexOf(showTo);

            $.each(headers, function (k,v) {
                if ( k > (showing - 2))
                    $("#"+v).hide();
                else
                    $("#"+v).show();
            });

            if (showing >= 2) {
                $("#divBtnBack").show()
            } else {
                $("#divBtnBack").hide()
            }

            if (showTo !== "loader") {
                if (msgShowed) {
                    $("#messenger").empty();
                } else {
                    msgShowed = true;
                }
            }
            $("#"+showTo).show();
        };

        $("#btn-back-action").click(function () {
            changeViewer(views[(showing - 1)])
        });

        var prepareListInventarios = function () {
            if (inventarios.length) {
                $("#list-empty").hide();
                $.each(inventarios, function (k, v) {
                    var dsc = "";
                    if (v.descricao === null) {
                        dsc = "Inventário " + v.id;
                    } else {
                        dsc = "Inv. " + v.id + " - " + v.descricao;
                    }
                    inventarios[k].dsc = dsc;
                    var newRow = $('<div class="row"><button class="btn gradientBtn selectInv" data-key="'+k+'" title="'+v.id+'">'+dsc+'</button></div>');
                    $("#list-inventarios").append(newRow);
                });
                $("#list-inventarios").show();
            }
            else {
                $("#list-empty").show();
                $("#list").hide();
            }
            changeViewer("list-inventarios")
        };

        var getInventarios = function () {
            $.ajax({url: "/mobile/inventario-novo/get-inventarios",
                success: function(result){
                    if (result.status === "ok") {
                        inventarios = result.response;
                        prepareListInventarios();
                    } else {
                        notificar("error", result.exception);

                    }
                }
            });
        };

        $(".selectInv").live("click",function () {
            invSelecioando = inventarios[$(this).data("key")];
            $("#lbl-inventario").text(invSelecioando.dsc);
            getContagens();
        });

        var controlaValidade = function () {
            return (!isEmpty(invSelecioando.controlaValidade) &&
                invSelecioando.controlaValidade !== 'N' &&
                (!isEmpty(elemBipado.controlaValidade) &&
                    elemBipado.controlaValidade === "S"))
        };

        var controlaLote = function () {
            return (!isEmpty(elemBipado.indControlaLote) &&
                     elemBipado.indControlaLote === "S")
        };

        var getContagens = function () {
            changeViewer("loader");
            $.ajax({url: "/mobile/inventario-novo/get-contagens/id/" + invSelecioando.id,
                success: function(result){
                    if (result.status === "ok") {
                        contagens = result.response;
                        prepareListContagens();
                    } else {
                        notificar("error", result.exception);
                    }
                }
            });
        };

        var prepareListContagens = function () {
            var rowsDivg = [];
            var rowsNor = [];

            $("#list-contagens").empty();

            $.each(contagens, function (k, v) {

                var dsc = v.contagem + "ª Contagem";
                var classe = "gradientBtn";

                if (v.divergencia === 'S'){
                    dsc += " de Divergência";
                    classe = "gradientBtnDanger"
                }
                contagens[k].dsc = dsc;
                var newRow = $('<div class="row"><button class="btn '+ classe +' selectCont" data-key="'+ k +'" title="'+ v.contagem +'">'+ dsc +'</button></div>');

                if (v.divergencia === 'S') {
                    rowsDivg.push(newRow);
                } else {
                    rowsNor.push(newRow)
                }

            });

            $.each($.merge(rowsNor, rowsDivg), function (k,v) {
                $("#list-contagens").append(v);
            });

            changeViewer("contagens-by-inventario");
        };

        $(".selectCont").live("click",function () {
            contSelecioando = contagens[$(this).data("key")];
            $("#lbl-contagem").text(contSelecioando.dsc);
            getEnderecos();
        });

        var getEnderecos = function () {
            changeViewer("loader");
            $.ajax({url: "/mobile/inventario-novo/get-enderecos/id/" + invSelecioando.id + "/sq/" + contSelecioando.sequencia,
                success: function(result){
                    if (result.status === "ok") {
                        enderecos = result.response;
                        prepareListEnderecos()
                    } else {
                        notificar("error", result.exception);
                    }
                }
            });
        };

        var prepareListEnderecos = function () {
            var list = $("#list-enderecos");
            list.empty();
            if (!$.isEmptyObject(enderecos)) {
                for (var i in enderecos){
                    list.append('<div class="list-item">' + i + '</div>')
                }
                changeViewer("bipagem-endereco");
                $("#cod-barras-end").focus();
            } else {
                notificar("warning", "A contagem " + contSelecioando.contagem + " já foi finalizada!");
                getContagens();
            }
        };

        $("#cod-barras-end").keypress(function( event ) {
            if ( event.which === 13  || event.keyCode === 13 ) {
                disarmEvent(event);
                if (!isEmpty($(this).val())) {
                    processEndereco($(this));
                    $(this).val("")
                }
            }
        });

        $("#btn-consultar-endereco").click(function( event ) {
            var input = $("#cod-barras-end");
            disarmEvent(event);
            if (!isEmpty(input.val())) {
                processEndereco(input);
                input.val("")
            }
        });

        var processEndereco = function (input) {

            var endFormated = formatEndereco(input.val());

            if (!endFormated) {
                notificar("error", "O código de barras não corresponde à um endereço");
            } else if ((enderecos[endFormated] !== undefined)) {
                idEndSelecionado = enderecos[endFormated];
                dscEndSelecionado = endFormated;
                $("#lbl-endereco").text(dscEndSelecionado);
                openEndereco()
            } else {
                notificar("error", "Este endereço "+input.val()+" não está no inventário");
                input.focus();
            }

            input.val("");
        };

        var openEndereco = function () {
            changeViewer("loader");
            $.ajax({
                url: "/mobile/inventario-novo/get-info-endereco/id/" + invSelecioando.id + "/sq/" + contSelecioando.sequencia + "/end/" + idEndSelecionado,
                success: function (result) {
                    produtos = [];
                    if (result.status === "ok") {
                        for (var index in result.response) {
                            produtos.push(result.response[index]);
                        }
                        prepareListProdutos();
                    } else {
                        notificar("error", result.exception);
                    }
                }
            })
        };

        var prepareListProdutos = function () {
            var list = $("#list-produtos");
            list.empty();
            if (produtos.length) {
                $.each(produtos , function (k,v) {
                    list.append('<div class="list-item">' + v.codProduto + " - " + v.grade + '</div>')
                });
            }

            if (contSelecioando.vazio === 'S') {
                $("#btn-finalizar").text("Finalizar Endereço Vazio")
            } else {
                $("#btn-finalizar").text("Finalizar Endereço")
            }

            changeViewer("bipagem-produto");
            $("#cod-barras-prod").focus();
        };

        $("#cod-barras-prod").keypress(function( event ) {
            if ( event.which === 13  || event.keyCode === 13 ) {
                disarmEvent(event);
                if (!isEmpty($(this).val())) {
                    processProduto($(this).val());
                    $(this).val("");
                }
            }
        });

        $("#btn-consultar-produto").click(function( event ) {
            var input = $("#cod-barras-prod");
            disarmEvent(event);
            if (!isEmpty(input.val())) {
                processProduto(input.val());
                input.val("");
            }
        });

        var processProduto = function (codBarras) {
            var liberado = true;
            if (produtos.length) {
                var encontrou = false;
                $.each(produtos, function (k,produto) {
                    if (produto.codBarras.indexOf(codBarras) >= 0) encontrou = true;
                });
                if (!encontrou) {
                    liberado = false;
                    notificar("error", "Este código de barras " + codBarras + " não pertence à nenhum produto deste inventário")
                }
            }

            if (!liberado) {
                return;
            }

            getInfoProduto(codBarras);
        };

        var getInfoProduto = function (codBarras) {
            changeViewer("loader");
            $.ajax({
                url: "/mobile/inventario-novo/get-info-produto/codbarras/" + codBarras ,
                success: function (result) {
                    if (result.status === "ok") {
                        elemBipado = result.response.produto;
                        usaGrade = (result.response.usaGrade === 'S');
                        prepareElement();
                    } else {
                        notificar("error", result.exception);
                    }
                }
            })
        };

        var prepareElement = function () {
            $("#lbl-produto").text([
                elemBipado.idProduto,
                elemBipado.descricao,
                ((usaGrade) ? elemBipado.grade : ""),
            ].join(" "));

            $("#lbl-embvol").text( elemBipado.descricaoEmbalagem + ((elemBipado.idEmbalagem !== null) ? "(" + elemBipado.quantidadeEmbalagem + ")" : "" ) );

            if (controlaValidade()) {
                $("#validade").val("");
                $("#div-validade").show();
            } else {
                $("#div-validade").hide();
            }

            if (controlaLote()) {
                $("#lote").val("");
                $("#div-lote").show();
            } else {
                $("#div-lote").hide();
            }

            changeViewer("conferencia");
            $("#qtd").val("");
        };

        $("#qtd, #validade, #lote").keypress(function( event ) {
            if ( event.which === 13  || event.keyCode === 13 ) {
                disarmEvent(event);
                if ( checkInputs(true) ) {
                    registrar();
                }
            }
        });

        $("#btn-registrar").click(function( event ) {
            disarmEvent(event);
            if ( checkInputs() ) {
                registrar();
            }
        });

        var checkInputs = function (toNext) {

            var inputQtd = $("#qtd");
            var inputVal = $("#validade");
            var inputLote = $("#lote");

            if (isEmpty(inputQtd.val())) {
                if (!toNext) notificar("warning", "A quantidade não foi informada");
                inputQtd.focus();
                return false;
            }

            if ( controlaValidade() && !isEmpty(inputVal.val())) {
                if (!toNext) notificar("warning", "A validade não foi informada");
                inputVal.focus();
                return false;
            }

            if ( controlaLote() && !isEmpty((inputLote.val()))) {
                if (!toNext) notificar("warning", "O Lote não foi informado");
                inputLote.focus();
                return false;
            }

            return true;
        };

        var registrar = function () {
            changeViewer("loader");
            $.post(
                "/mobile/inventario-novo/contagem-produto",
                {
                    inventario: invSelecioando,
                    contagem: contSelecioando,
                    produto: elemBipado,
                    conferencia: {
                        qtd: $("#qtd").val(),
                        validade: $("#validade").val(),
                        lote: $("#lote").val()
                    }
                }
            ).done(function( result ) {
                if (result.status === "ok") {
                    notificar("success", result.response);
                } else {
                    notificar("error", result.exception)
                }
                prepareListProdutos();
                changeViewer("bipagem-produto");
            })
        };

        $("#btn-finalizar").click(function () {
            changeViewer("loader");
            $.post(
                "/mobile/inventario-novo/finalizar-contagem-os",
                {
                    inventario: invSelecioando,
                    contagem: contSelecioando
                }
            ).done(function( result ) {
                if (result.status === "ok") {
                    notificar("success", result.response.msg);
                    if (result.response.code !== 4) {
                        getContagens();
                        changeViewer("contagens-by-inventario");
                    } else if (result.response.code === 4) {
                        getInventarios();
                        changeViewer("list-inventarios");
                    }
                } else {
                    notificar("error", result.exception);
                    changeViewer("bipagem-produto");
                }
            })
        });
    })
</script>
