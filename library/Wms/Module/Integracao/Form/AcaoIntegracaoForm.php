<?php
namespace Wms\Module\Integracao\Form;
use Core\Form\SubForm;
use Wms\Domain\Entity\Integracao\AcaoIntegracaoFiltro;
use Wms\Domain\Entity\Integracao\ConexaoIntegracao;
use Wms\Domain\Entity\Util\Sigla;

/**
 * Created by PhpStorm.
 * User: Tarcísio César
 * Date: 17/06/2020
 * Time: 16:00
 */

class AcaoIntegracaoForm extends SubForm
{
    public function init()
    {

        $this->setAttribs(array('id' => 'cadastar-integracao-form', 'class' => 'form'));
        $conexoes = [];
        foreach ($this->getEm()->createQueryBuilder()
            ->select('c.id, c.descricao')
            ->from(ConexaoIntegracao::class, 'c')->getQuery()->getResult() as $con) {
            $conexoes[$con['id']] = $con['descricao'];
        }

        $tipos = $this->getEm()->getRepository(Sigla::class)->getIdValue(79);

        $this->addElement('hidden', 'id')
            ->addElement('text', 'dscAcaoIntegracao', array(
                'label' => 'Descrição',
                'size' => 30,
            ))
            ->addElement('select', 'conexao', array(
                'mostrarSelecione' => true,
                'multiOptions' => $conexoes,
                'label' => 'Conexão',
                'require' => true
            ))
            ->addElement('select', 'tipoAcao', [
                'label' => 'Cod. Tipo Ação',
                'mostrarSelecione' => true,
                'multiOptions' => $tipos,
                'require' => true
            ])
            ->addElement('checkbox', 'indUtilizaLog', array(
                'label' => 'Usa LOG',
                'checkedValue' => 'S',
                'uncheckedValue' => 'N'
            ))
            ->addElement('text', 'tipoControle', array(
                'size' => 2,
                'label' => 'Tipo Controle',
            ))
            ->addElement('text', 'tabelaReferencia', array(
                'size' => 15,
                'label' => 'Tabela Referêcia',
            ))
            ->addElement('text', 'idAcaoRelacionada', array(
                'size' => 3,
                'label' => 'Ações Relacionadas',
            ))
            ->addElement('textarea', 'query', array(
                'label' => 'Script',
                'class' => 'text-area',
                'rows' => "20",
                'cols' => "137"
            ))
            ->addElement('text', 'filtro610', array(
                'size' => 70,
                'label' => 'Filtro por data específica',
            ))
            ->addElement('text', 'filtro611', array(
                'size' => 70,
                'label' => 'Filtro por código específico',
            ))
            ->addElement('text', 'filtro612', array(
                'size' => 70,
                'label' => 'Filtro por lista de códigos',
            ))
            ->addElement('text', 'filtro613', array(
                'size' => 70,
                'label' => 'Filtro por intervalo de códigos',
            ))
            ->addElement('submit', 'salvar', array(
                'class' => 'btn right',
                'label' => 'Salvar',
                'decorators' => array('ViewHelper'),
            ))
            ->addDisplayGroup(array('dscAcaoIntegracao', 'conexao', 'tipoAcao', 'tipoControle', 'tabelaReferencia', 'idAcaoRelacionada', 'indUtilizaLog', 'query', 'filtro-610', 'filtro-611', 'filtro-612', 'filtro-613', 'salvar'), 'cadastro-integracao', array('legend' => 'Cadastro de Integração'));
    }

    public function setDefaults(array $defaults, $filtros = [])
    {
        $defaults['conexao'] = $defaults['conexao']->getId();
        $defaults['tipoAcao'] = $defaults['tipoAcao']->getId();
        /** @var AcaoIntegracaoFiltro $filtro */
        foreach ($filtros as $filtro) {
            $defaults['filtro'.$filtro->getTipoRegistro()->getId()] = $filtro->getFiltro();
        }

        return parent::setDefaults($defaults); // TODO: Change the autogenerated stub
    }
}