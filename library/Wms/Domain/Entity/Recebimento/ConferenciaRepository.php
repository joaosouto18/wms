<?php

namespace Wms\Domain\Entity\Recebimento;

use Doctrine\ORM\EntityRepository,
    Wms\Domain\Entity\Produto\Conferencia as ConferenciaEntity;

/**
 * Conferencia
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ConferenciaRepository extends EntityRepository
{

    public function getLastOsConferencia ($idRecebimento, $idProduto, $grade)
    {
		$query = "
					SELECT DTH_FINAL_ATIVIDADE, COD_OS FROM (
					SELECT CASE WHEN OS.DTH_FINAL_ATIVIDADE IS NULL THEN TO_DATE('31/12/9999','dd/mm/yyyy')
								ELSE OS.DTH_FINAL_ATIVIDADE END AS DTH_FINAL_ATIVIDADE,
								  RC.COD_OS
					  FROM RECEBIMENTO_CONFERENCIA RC
					  LEFT JOIN ORDEM_SERVICO OS ON RC.COD_OS = OS.COD_OS
					WHERE RC.COD_RECEBIMENTO = $idRecebimento  
					  AND RC.COD_PRODUTO = $idProduto
					  AND RC.DSC_GRADE = '$grade') ORDER BY DTH_FINAL_ATIVIDADE DESC
		";
        $result = $this->getEntityManager()->getConnection()->query($query)-> fetchAll(\PDO::FETCH_ASSOC);

		if ($result == NULL) {
			return 0;
		} else {
			return $result[0]['COD_OS'];
		}
	}

    public function getLastOsRecebimentoEmbalagem ($idRecebimento, $idProduto, $grade)
    {
        $query = "
            SELECT COD_OS
              FROM (SELECT DISTINCT
                           CASE WHEN OS.DTH_FINAL_ATIVIDADE IS NULL THEN TO_DATE('31/12/9999','dd/mm/yyyy')
                                                ELSE OS.DTH_FINAL_ATIVIDADE END AS DTH_FINAL_ATIVIDADE,
                           OS.COD_OS
                      FROM ORDEM_SERVICO OS
                     INNER JOIN RECEBIMENTO_EMBALAGEM RE ON RE.COD_OS = OS.COD_OS
                     INNER JOIN PRODUTO_EMBALAGEM PE ON PE.COD_PRODUTO_EMBALAGEM = RE.COD_PRODUTO_EMBALAGEM
                     WHERE OS.COD_RECEBIMENTO = '$idRecebimento'
                       AND COD_PRODUTO = '$idProduto'
                       AND DSC_GRADE = '$grade') QTD
             ORDER BY DTH_FINAL_ATIVIDADE DESC";
        $result = $this->getEntityManager()->getConnection()->query($query)-> fetchAll(\PDO::FETCH_ASSOC);

        if ($result == NULL) {
            return 0;
        } else {
            return $result[0]['COD_OS'];
        }
    }

    public function getLastOsRecebimentoVolume ($idRecebimento, $idProduto, $grade)
    {
        $query = "
            SELECT COD_OS
              FROM (SELECT DISTINCT
                           CASE WHEN OS.DTH_FINAL_ATIVIDADE IS NULL THEN TO_DATE('31/12/9999','dd/mm/yyyy')
                                                ELSE OS.DTH_FINAL_ATIVIDADE END AS DTH_FINAL_ATIVIDADE,
                           OS.COD_OS
                      FROM ORDEM_SERVICO OS
                     INNER JOIN RECEBIMENTO_VOLUME RV ON RV.COD_OS = OS.COD_OS
                     INNER JOIN PRODUTO_VOLUME PV ON PV.COD_PRODUTO_VOLUME = RV.COD_PRODUTO_VOLUME
                     WHERE OS.COD_RECEBIMENTO = '$idRecebimento'
                       AND COD_PRODUTO = '$idProduto'
                       AND DSC_GRADE = '$grade') QTD
             ORDER BY DTH_FINAL_ATIVIDADE DESC";
        $result = $this->getEntityManager()->getConnection()->query($query)-> fetchAll(\PDO::FETCH_ASSOC);

        if ($result == NULL) {
            return 0;
        } else {
            return $result[0]['COD_OS'];
        }
    }

    public function getOsConferida ($idRecebimento, $idProduto, $grade)
    {
        $source = $this->getEntityManager()->createQueryBuilder()
            ->select("os.id")
            ->from("wms:Recebimento\Conferencia","c")
            ->innerJoin("c.ordemServico" , "os")
            ->where("c.recebimento = $idRecebimento")
            ->andWhere("c.grade = '$grade'")
            ->andWhere("c.codProduto = $idProduto")
            ->andWhere("(c.qtdDivergencia = 0 OR (c.qtdDivergencia != 0 AND NOT(c.notaFiscal IS NULL)))");
        $conferencia =  $source->getQuery()->getResult(\Doctrine\ORM\Query::HYDRATE_ARRAY);

        if (count($conferencia) <= 0) {
            return 0;
        } else{
            return $conferencia[0]['id'];
        }
    }

    public function getQtdByRecebimentoVolumeAndNorma ($idOs, $codProduto, $grade){
        $SQL = "SELECT MIN (QTD) as QTD, COD_NORMA_PALETIZACAO, NUM_NORMA, COD_UNITIZADOR
                  FROM (SELECT SUM(QTD_CONFERIDA) as QTD, RV.COD_PRODUTO_VOLUME, RV.COD_NORMA_PALETIZACAO, NP.NUM_NORMA, NP.COD_UNITIZADOR
                          FROM RECEBIMENTO_VOLUME RV
                         INNER JOIN PRODUTO_VOLUME PV ON PV.COD_PRODUTO_VOLUME = RV.COD_PRODUTO_VOLUME
                         INNER JOIN NORMA_PALETIZACAO NP ON NP.COD_NORMA_PALETIZACAO = RV.COD_NORMA_PALETIZACAO
                         WHERE COD_OS = '$idOs'
                           AND PV.COD_PRODUTO = '$codProduto'
                           AND PV.DSC_GRADE = '$grade'
                         GROUP BY RV.COD_PRODUTO_VOLUME, RV.COD_NORMA_PALETIZACAO, NP.NUM_NORMA, COD_UNITIZADOR)
                 GROUP BY COD_NORMA_PALETIZACAO, NUM_NORMA, COD_UNITIZADOR";
        $result = $this->getEntityManager()->getConnection()->query($SQL)-> fetchAll(\PDO::FETCH_ASSOC);
        return $result;
    }

    public function getQtdByRecebimentoEmbalagemAndNorma ($idOs, $codProduto, $grade){
        $SQL = "SELECT SUM(RE.QTD_CONFERIDA * PE.QTD_EMBALAGEM) as QTD, RE.COD_NORMA_PALETIZACAO, NP.NUM_NORMA, NP.COD_UNITIZADOR
                  FROM RECEBIMENTO_EMBALAGEM RE
                 INNER JOIN PRODUTO_EMBALAGEM PE ON PE.COD_PRODUTO_EMBALAGEM = RE.COD_PRODUTO_EMBALAGEM
                 INNER JOIN NORMA_PALETIZACAO NP ON NP.COD_NORMA_PALETIZACAO = RE.COD_NORMA_PALETIZACAO
                 WHERE COD_OS = '$idOs'
                   AND PE.COD_PRODUTO = '$codProduto'
                   AND PE.DSC_GRADE = '$grade'
                 GROUP BY RE.COD_NORMA_PALETIZACAO, NP.NUM_NORMA, NP.COD_UNITIZADOR";
        $result = $this->getEntityManager()->getConnection()->query($SQL)-> fetchAll(\PDO::FETCH_ASSOC);
        return $result;
    }

    public function getQtdByRecebimento ($idRecebimento, $idProduto, $grade)
    {
        $query = $this->getEntityManager()->createQueryBuilder()
            ->select("r.qtd, r.codNormaPaletizacao as idNormaPaletizacao, np.numNorma, un.id as idUnitizador")
            ->from("wms:Recebimento\VQtdRecebimento", "r")
            ->leftjoin("wms:Produto\NormaPaletizacao", "np","WITH","np.id = r.codNormaPaletizacao")
            ->leftJoin('np.unitizador','un')
            ->where("r.codProduto = '$idProduto'")
            ->andWhere("r.grade = '$grade'")
            ->andWhere("r.codRecebimento = $idRecebimento");
        $result = $query->getQuery()->getArrayResult();

        if (count($result) > 0) {
            return $result;
        } else {
            return array();
        }
    }

    /**
     *
     * @param int $idOrdemServico
     * @return array Result set 
     */
    public function getProdutoDivergencia($idOrdemServico)
    {
        $sql = $this->getEntityManager()->createQuery('
                SELECT c.id, p.id idProduto, p.grade, p.descricao dscProduto, c.qtdConferida, c.qtdAvaria, c.qtdDivergencia, p.referencia
                FROM wms:Recebimento\Conferencia c
                INNER JOIN c.produto p
                WHERE c.ordemServico = ?1
                    AND p.grade = c.grade
                    AND c.qtdDivergencia != 0')
                ->setParameter(1, $idOrdemServico);

        return $sql->getResult();
    }

}
